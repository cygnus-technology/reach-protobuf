image: python:3.8

definitions:
    steps:
      - step: &generate-java-kotlin-csharp-cpp-python-proto
          name: Generate Java, Kotlin, C#, C++ and Python code from .proto files
          caches:
            - node
            - pip
          script:
            - apt-get update && apt-get install -y protobuf-compiler  # Install protobuf-compiler
            - mkdir ./java/generated
            - protoc -I=./proto --java_out=./java/generated services.proto reach.proto
            - mkdir ./kotlin/generated
            - protoc -I=./proto --kotlin_out=./kotlin/generated services.proto reach.proto
            - mkdir ./csharp/generated
            - protoc -I=./proto --csharp_out=./csharp/generated services.proto reach.proto
            - mkdir ./cpp/generated
            - protoc -I=./proto --cpp_out=./cpp/generated services.proto reach.proto 
            - mkdir ./python/generated
            - protoc -I=./proto --python_out=./python/generated services.proto reach.proto
          artifacts:
            - 'java/generated/**'
            - 'kotlin/generated/**'
            - 'csharp/generated/**'
            - 'cpp/generated/**'
            - 'python/generated/**'
      - step: &generate-ansic-nanopb
          name: Generate C code from .proto files
          script:
            - pip install protobuf grpcio-tools
            - git clone https://github.com/nanopb/nanopb.git
            - mkdir ./ansic/generated
            - ./nanopb/generator/nanopb_generator.py -I=./proto --output-dir=./ansic/generated services.proto reach.proto
          artifacts:
            - 'ansic/generated/**'
      - step: &generate-ts-nanopb
          name: Generate TS code from .proto files
          script:
            - apt-get update && apt-get install -y protobuf-compiler nodejs npm
            - npm install -g ts-proto
            - cd ts
            - npm ci
            - mkdir ./generated
            - cd ../
            - protoc --plugin=./ts/node_modules/.bin/protoc-gen-ts_proto -I=./proto --ts_proto_out=./ts/generated services.proto reach.proto
          artifacts:
            - 'ts/generated/**'
      
pipelines:
  branches:
    development:
      - step:
          <<: *generate-java-kotlin-csharp-cpp-python-proto
      - step:
          <<: *generate-ansic-nanopb
      - step:
          <<: *generate-ts-nanopb
    master:
      - step:
          <<: *generate-java-kotlin-csharp-cpp-python-proto
      - step:
          <<: *generate-ansic-nanopb
      - step:
          <<: *generate-ts-nanopb